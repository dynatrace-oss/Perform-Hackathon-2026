# k6 Load Tests

## Overview

k6 is a modern load testing tool that generates HTTP traffic to test application performance, scalability, and reliability under various load conditions.

## What k6 Tests Do

The k6 test script (`load-test.js`) simulates multiple virtual users performing:

1. **Enter Casino** - POST `/api/user/init`
2. **Deposit Funds** - POST `/api/user/topup`
3. **Play Games** - POST `/api/games/{game}/{action}` with feature flags
4. **Deposit Again** - POST `/api/user/topup`
5. **Check Dashboard** - GET `/api/dashboard/{game}`

## Test Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `CASINO_URL` | `http://localhost:3000` | Frontend service URL |
| `VUS` | `10` | Virtual Users (concurrent) |
| `DURATION` | `5m` | Test duration |
| `RAMP_UP` | `30s` | Ramp-up time |

### Test Stages

k6 uses a staged approach:

1. **Ramp-up**: Gradually increase to target VUs
2. **Sustained Load**: Maintain VUs for duration
3. **Ramp-down**: Gradually decrease to 0

Example:
```javascript
stages: [
  { duration: '30s', target: 10 },  // Ramp up to 10 VUs
  { duration: '5m', target: 10 },   // Stay at 10 VUs
  { duration: '30s', target: 0 },   // Ramp down
]
```

## Metrics

### Built-in Metrics
- `http_req_duration`: Request duration
- `http_req_failed`: Failed request rate
- `http_reqs`: Total requests
- `vus`: Virtual users
- `iterations`: Completed iterations

### Custom Metrics
- `errors`: Error rate
- `success`: Success rate

## Thresholds

Default thresholds:
- 95% of requests < 2 seconds
- Error rate < 10%
- Success rate > 90%

## Running k6 Tests

### Via Helm

```bash
# Enable and configure
helm upgrade --install vegas-casino ./helm/vegas-casino \
  --set k6.enabled=true \
  --set k6.vus=20 \
  --set k6.duration=10m \
  --set k6.rampUp=1m
```

### Via Kubernetes Job

```bash
# Create job manually
kubectl create job k6-load-test \
  --image=hrexed/vegasapp-k6:0.10 \
  --env="CASINO_URL=http://vegas-casino-frontend:3000" \
  --env="VUS=20" \
  --env="DURATION=10m"
```

### Locally

```bash
# Install k6
brew install k6  # macOS
# or download from https://k6.io/docs/getting-started/installation/

# Run test
k6 run services/k6/load-test.js \
  --env CASINO_URL=http://localhost:3000 \
  --env VUS=10 \
  --env DURATION=5m
```

### Via Docker

```bash
# Build image
make docker-build-k6

# Run locally
docker run --rm \
  -e CASINO_URL=http://localhost:3000 \
  -e VUS=20 \
  -e DURATION=10m \
  hrexed/vegasapp-k6:0.10
```

## Test Scenarios

### Light Load
```yaml
k6:
  vus: "5"
  duration: "2m"
  rampUp: "30s"
```

### Medium Load
```yaml
k6:
  vus: "20"
  duration: "10m"
  rampUp: "1m"
```

### Heavy Load
```yaml
k6:
  vus: "50"
  duration: "30m"
  rampUp: "5m"
```

## Output

k6 provides detailed output:

```
     ✓ entered casino successfully
     ✓ deposit successful
     ✓ balance updated
     ✓ slots game played
     ✓ game response valid
     ✓ dashboard loaded
     ✓ dashboard has data

     checks.........................: 100.00% ✓ 350    ✗ 0
     data_received..................: 2.1 MB  7.0 kB/s
     data_sent......................: 450 kB  1.5 kB/s
     http_req_duration..............: avg=245ms min=120ms med=230ms max=890ms p(95)=450ms
     http_req_failed................: 0.00%   ✓ 0      ✗ 350
     http_reqs......................: 350    1.166667/s
     iterations.....................: 50     0.166667/s
     vus............................: 10     min=10    max=10
```

## Interpreting Results

### Good Performance
- `http_req_duration p(95) < 2000ms`
- `http_req_failed < 0.1`
- `errors < 0.1`
- `success > 0.9`

### Performance Issues
- High `http_req_duration` → Service overload
- High `http_req_failed` → Service errors
- Increasing `vus` → Resource constraints

## Advanced Configuration

### Custom Test Scenarios

Edit `load-test.js` to add custom scenarios:

```javascript
export const options = {
  scenarios: {
    spike: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '10s', target: 100 },
        { duration: '1m', target: 100 },
        { duration: '10s', target: 0 },
      ],
    },
  },
};
```

### Custom Metrics

Add custom metrics:

```javascript
import { Trend, Counter } from 'k6/metrics';

const gamePlayDuration = new Trend('game_play_duration');
const depositsCount = new Counter('deposits_total');
```

## Troubleshooting

### High Error Rate
- Check service availability
- Verify CASINO_URL is correct
- Review service logs
- Check resource limits

### Slow Response Times
- Increase service replicas
- Check database performance
- Review Redis connectivity
- Monitor resource usage

### Test Fails to Start
- Verify CASINO_URL is accessible
- Check k6 image is built
- Review job logs: `kubectl logs job/k6-load-test`

---

**Next**: Learn about [Deployment](../deployment/index.md) or return to [Testing Overview](index.md).

